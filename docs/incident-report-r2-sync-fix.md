# 事象報告書: R2バックアップ同期エラーの修正

## 基本情報

| 項目 | 内容 |
|------|------|
| プロジェクト | Moltworker（Cloudflare Workers上で動くAIチャットアシスタント） |
| 発生日 / 対応日 | 2026-02-08 |
| 対応者 | Claude Code |
| ステータス | **解決済み** |

---

## 第1部: わかりやすい解説（概要）

### 何が起きていたか

Admin UI（管理画面）に「Last backup: Never」と表示され、データのバックアップが一度も成功していない状態でした。チャット機能そのものは正常に動いていたため、見た目上は気づきにくい問題でした。

具体的には、バックアップ処理が「**Sync aborted: no config file found**（設定ファイルが見つからないため中止します）」というエラーで毎回失敗していました。

この状態が続くと、コンテナ（後述）が再起動したときにペアリング情報が消えてしまい、再度承認作業が必要になります。

---

### Moltworkerの仕組み（前提知識）

Moltworkerは以下のような仕組みで動いています。

```
┌─────────────────────────────────────────────────┐
│  Cloudflare コンテナ（一時的な作業場所）          │
│                                                   │
│  ・AIチャットが動いている                         │
│  ・ただし再起動すると中身がすべて消える           │
│                                                   │
│         ↕ 5分ごとにバックアップ                   │
│                                                   │
│  R2ストレージ（永続的な保管庫）                   │
│  ・コンテナの中身をここに保存しておく             │
│  ・再起動後はここからデータを復元する             │
└─────────────────────────────────────────────────┘
```

- **コンテナ**: プログラムが動く「一時的な箱」です。中身は再起動で消えます
- **R2ストレージ**: Cloudflareが提供する「永続的な保管庫」です。再起動しても消えません
- **バックアップ**: コンテナの中身をR2に保存する処理で、5分ごとに自動で実行されます
- **復元**: コンテナ再起動時にR2からデータを取り出して元に戻す処理です

---

### 何が壊れていたか（タイミング問題）

原因は「起動の順番」にありました。

コンテナが起動するとき、内部で設定ファイル（`openclaw.json`）を作る処理が走りますが、この処理に**約2分**かかります。一方、バックアップ処理はこの2分を**待たずに**実行されてしまっていました。

```
時間の流れ →

コンテナ起動                設定ファイル完成
    |                            |
    |===== 約2分かかる =========|
    |                            |
    |   ↑ ここでバックアップが   |
    |     走ってしまう           |
    |                            |
    |   → 「設定ファイルがない！」|
    |   → エラーで中止           |
```

いわゆる**「鶏と卵」問題**（鶏卵問題）です。バックアップには設定ファイルが必要ですが、設定ファイルはまだ作成中だった、という状態です。

---

### なぜチャットは動いていたか

チャット機能はゲートウェイ（通信の仲介役）が動いていれば使えます。バックアップの成功・失敗とは無関係なため、バックアップが壊れていてもチャットには影響がありませんでした。

---

### どう直したか

**修正のポイント**: バックアップを実行する前に「準備が整っているか」を確認するステップを追加しました。

#### 修正1: 自動バックアップ（5分ごとの定期実行）

| | 修正前 | 修正後 |
|---|---|---|
| チェック内容 | プロセス（プログラム）が存在するかだけ確認 | プロセスが存在する **かつ** 実際に応答するか確認 |
| 問題点 | 起動中でも「存在する」と判定 → エラー | 応答しなければスキップ → エラー回避 |

#### 修正2: 手動バックアップ（Admin UIの「Backup Now」ボタン）

| | 修正前 | 修正後 |
|---|---|---|
| 動作 | いきなりバックアップを実行 | まずゲートウェイの起動完了を待ってから実行 |
| エラー時 | そのままエラー | 起動失敗なら「503（サービス利用不可）」を返す |

---

### 修正後の確認結果

- Admin UI: 「Last backup: **2026/2/8 22:26:33**」に更新されました
- デバッグ画面: 「**Sync completed successfully**」が表示されました
- R2ストレージにバックアップデータが保存されていることを確認しました

---

### 今後の運用（日常で気にすること）

- **普段はControl UI（チャット画面）でチャットするだけでOKです**
- バックアップは5分ごとに自動で行われます
- コンテナが再起動しても、R2から自動でデータが復元されます
- Admin UI（管理画面）は確認やトラブル発生時にのみ使用してください

---
---

## 第2部: 技術詳細

以下はトラブルシューティングや今後の保守のための技術的な記録です。

---

### 調査で判明した事実

#### openclaw.json の生成タイミング

`openclaw.json` は `start-openclaw.sh` スクリプト内の以下のコマンドで生成されます。

```bash
openclaw onboard --non-interactive
```

このコマンドの完了までに約2分を要します。

#### syncToR2() が呼び出される3つのパス

| # | 呼び出し元 | ファイル | 状況 |
|---|-----------|---------|------|
| 1 | Cron（定期実行） | `src/index.ts` | `findExistingMoltbotProcess` でチェックしていたが、`start-openclaw.sh` がrunning状態の時点で `true` を返してしまっていた |
| 2 | Admin API | `src/routes/api.ts` (248行目付近) | チェックが**一切なかった** |
| 3 | Debug | `src/routes/debug.ts` | `ensureMoltbotGateway()` で保護済み（問題なし） |

#### プロセスログの時系列

実際のログから確認した起動シーケンスです。

```
13:08:54  start-openclaw.sh 起動
    ↓
13:10:34  ls openclaw.json → exitCode=2（まだ存在しない）
          ← ★ ここで sync が失敗していた
    ↓
13:10:57  openclaw onboard 完了（openclaw.json 生成）
    ↓
13:11:16  ゲートウェイがポート 18789 でリッスン開始
    ↓
13:15:34  ls openclaw.json → FOUND（成功）
```

起動開始からゲートウェイが応答可能になるまで約2分22秒かかっています。この間にCronまたはAdmin APIからsyncが呼ばれるとエラーになっていました。

---

### 修正内容の技術詳細

#### 修正1: Cron syncハンドラ (`src/index.ts`)

**修正前**: `findExistingMoltbotProcess` でプロセスの存在のみを確認していました。`start-openclaw.sh` が起動中（まだ `openclaw onboard` 実行中）でもプロセスとしては存在するため `true` を返し、バックアップを試行してエラーになっていました。

**修正後**: プロセスの存在確認に加え、`containerFetch` を使ってゲートウェイがポート18789で実際に応答するかをチェックするようにしました。応答がなければバックアップをスキップします。

#### 修正2: Admin API syncハンドラ (`src/routes/api.ts`)

**修正前**: `syncToR2()` を直接呼び出していたため、ゲートウェイが未起動の場合にエラーが発生していました。

**修正後**: `ensureMoltbotGateway()` を先に呼び出し、ゲートウェイの起動完了を待ってから `syncToR2()` を実行するようにしました。ゲートウェイの起動に失敗した場合は HTTP 503（Service Unavailable）を返します。

---

### 追加発見事項: デバッグルートのパス問題

調査中にデバッグルートへのアクセスに関する問題も発見しました。

- `/_admin/debug/*` にアクセスすると、Admin UIのSPA（シングルページアプリケーション）にキャッチされてしまい、デバッグエンドポイントに到達しません
- 正しいパスは **`/debug/*`** です
- `DEBUG_ROUTES` 環境変数が `true` に設定されている必要があります

---

### 関連URL

| 用途 | URL |
|------|-----|
| Control UI（チャット画面） | https://moltbot-sandbox.keitay24.workers.dev/?token=1b1fd31981eb4e3b86f0962a41e3871731bb024e9a98455f8c317ec7f545e792 |
| Admin UI（管理画面） | https://moltbot-sandbox.keitay24.workers.dev/_admin/ |
| GitHub リポジトリ | https://github.com/key-24/moltworker |
| Cloudflare Dashboard | https://dash.cloudflare.com/ |

---

### 関連ファイル一覧

| ファイル | 役割 |
|---------|------|
| `src/gateway/sync.ts` | R2同期の実装（エラー発生箇所: 49-62行目） |
| `src/index.ts` | Cron syncハンドラ（**今回の修正箇所**） |
| `src/routes/api.ts` | Admin API syncハンドラ（**今回の修正箇所**） |
| `src/gateway/process.ts` | ゲートウェイ起動管理 |
| `start-openclaw.sh` | コンテナ起動スクリプト（openclaw.json 生成元） |
| `src/routes/debug.ts` | デバッグエンドポイント |

---

*この報告書は 2026-02-08 に Claude Code によって作成されました。*
